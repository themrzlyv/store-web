name: Deploy Store App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key for GitHub connection
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 157.173.205.31
          username: root
          key: ${{ secrets.STORE_WEB_KEY }}
          port: 22
          script: |
            # SSH into VPS and perform deployment
            echo "Logged into VPS at $HOST"
            cd /var/www/store-web
            # Stop and remove the old container
            echo "Stopping and removing old container..."
            docker-compose down || echo "Failed to stop/remove old container"

            # Pull latest code from GitHub
            git pull origin main || echo "Failed to pull from GitHub"

            # Build and start new container
            echo "Building and starting new container..."
            echo "API_URL=${{ vars.API_URL }}"
            DATABASE_URL=${{ vars.DATABASE_URL }} API_URL=${{ vars.API_URL }} docker-compose up -d --build

            echo "Deployment finished"
        env:
          DATABASE_URL: ${{ vars.DATABASE_URL }}
